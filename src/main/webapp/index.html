<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<link rel="shortcut icon" href="favicon.png">
	<title>Web Kanban</title>
</head>
<body>
<textarea rows="1" id="stories" style="visibility: hidden;">
TODO,1,sleep at night
WIP,2,rest in front of the tv
DONE,3,eat. a lot.
</textarea>

<textarea rows="1" id="states" style="visibility: hidden;">
TODO,Todo
WIP,In Progress
DONE,Done
</textarea>

<a id="data_link" class="button" href="#" style="float:right;">Data</a>
<a id="board_link" class="button" href="#" style="float:right;">Board</a>

<h1>Web Kanban</h1>

<div id="output"></div>
<div class="clear"></div>

<textarea id="data_output" rows="20" cols="100">
</textarea>

<style>
	#TODO .box {
		background-color: hotpink;
		color: #000000;
	}

	#WIP .box {
		background-color: lemonchiffon;
		color: #000000;
	}

	#DONE .box {
		background-color: cornflowerblue;
		color: #000000;
	}
</style>

<style>
	.button {
		background-color: #e0e0e0;
		color: #a0a0a0;
		padding: 0.2em;
		text-decoration: none;
	}

	.placeholder {
		border: 1px solid black;
	}

	ul {
		list-style: none;
		margin: 0 0 0 0;
		padding: 0 0 0 0;
	}

	body {
		font-family: Helvetica, sans-serif;
	}

	.box {
		font-size: 80%;
		padding: 0.2em;
		border: 1px solid grey;
		margin-bottom: 1em;
		margin-right: 5px;
		min-height: 50px;
		-moz-border-radius: 3px;
		-webkit-border-radius: 3px;
		-border-radius: 3px;
		-moz-box-shadow: 4px 4px 8px lightgray;
		-webkit-box-shadow: 4px 4px 8px lightgray;
		-box-shadow: 4px 4px 8px lightgray;
	}

	.dp10 {
		width: 150px;
		float: left;
		display: inline;
		margin-right: -1px;
	}

	.clear {
		clear: both;
	}

	.headline {
		font-weight: bold;
		height: 3em;
		color: #000000;
	}

	.footer {
		font-size: 80%;
		color: #808080;
		padding-top: 5em;
	}
</style>

<div class="clear"></div>
<footer>
	Written by Stephan Schmidt, who can be found on Twitter <a href="http://twitter.com/codemonkeyism">http://twitter.com/codemonkeyism</a>,
	Blog at <a href="http://www.codemonkeyism.com">http://www.codemonkeyism.com</a>, using
	JQuery with the DragSort plugin<br>
	This software application is Twitter-Ware. If you like it, use it, or have something to say, <b>follow me</b> and
	tell me on Twitter at @codemonkeyism<br/>
	The newest version can be found on <a href="http://www.simple-kanban.com">www.simple-kanban.com</a>
</footer>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.js"></script>
<script>!window.jQuery && document.write(unescape('%3Cscript src="js/libs/jquery-1.7.2.js"%3E%3C/script%3E'))</script>
<script src="js/libs/jquery.dragsort-0.5.1.js"></script>
<script>
	$("#board_link").hide();
	$("#data_output").hide();

	var init_states = function (states_input) {
		var states = {};
		var states_order = [];
		for (var i = 0, len = states_input.length; i < len; i++) {
			var state = states_input[i].split(",");
			if (state.length == 2) {
				states[state[0]] = state[1];
				states_order.push(state[0]);
			}
		}
		return {states:states, states_order:states_order};
	};

	var init_board = function (stories) {
		var board = {};
		for (var i = 0, len = stories.length; i < len; i++) {
			var story = stories[i].split(",");
			var state = story[0];
			if (story.length == 3) {
				if (!board[state]) {
					board[state] = [];
				}
				board[state].push(story);
			}
		}
		return board;
	};

	var create_list = function (board, state) {
		var list = $("<ul class=\"state\" id=\"" + state + "\"></ul>");
		if (board[state]) {
			for (var i = 0, len = board[state].length; i < len; i++) {
				var story_element = $("<li><div class=\"box box_" + state + "\">" + board[state][i][1] + " " + board[state][i][2] + "</div></li>");
				story_element.data("story", board[state][i]);
				list.append(story_element);
			}
		}
		return list;
	};

	var create_column = function (board, state, headline) {
		var state_column = $("<div class=\"dp10\"></div>");
		state_column.append($("<div class=\"headline\">" + headline + "</div>"));
		state_column.append(create_list(board, state));
		state_column.data("state", state);
		return state_column;
	};

	var create_board = function (app_data) {
		var table = $('<div id="board"></div>');
		var ids = "";
		for (j = 0; j < app_data.states_order.length; j++) {
			var state = app_data.states_order[j];
			ids += "#" + state + ",";
			var state_column = create_column(app_data.board, state, app_data.states[state]);
			table.append(state_column);
		}
		$(ids, table).dragsort({ dragBetween:true });
		return table;
	};

	$("#board_link").click(function () {
		var state_data = init_states($("#states").text().split("\n"));
		var app_data = { board:init_board($("#data_output").val().split("\n")), states:state_data.states, states_order:state_data.states_order};
		$("#output").empty();
		$("#output").append(create_board(app_data));

		$("#output").show();
		$("#data_link").show();
		$("#data_output").hide();
		$("#board_link").hide();
	});

	$("#data_link").click(function () {
		var data = "";
		$("#board .dp10").each(function () {
			var state = $(this).data("state");
			$(this).find("li").each(function () {
				var story = $(this).data("story");
				data += state + "," + story[1] + "," + story[2] + "\n";
			});
		});
		$("#data_output").val(data);
		$("#output").hide();
		$("#data_link").hide();
		$("#data_output").show();
		$("#board_link").show();
	});

	var state_data = init_states($("#states").text().split("\n"));
	var app_data = { board:init_board($("#stories").text().split("\n")), states:state_data.states, states_order:state_data.states_order};
	$("#output").empty();
	$("#output").append(create_board(app_data));
</script>
</body>
</html>
